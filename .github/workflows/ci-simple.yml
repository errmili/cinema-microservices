name: Cinema CI/CD - Build + Docker

# Quand dÃ©clencher ce pipeline
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # =================== JOB 1: BUILD ET TEST ===================
  build-test:
    runs-on: ubuntu-latest

    steps:
      # Ã‰tape 1: RÃ©cupÃ©rer ton code
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v3

      # Ã‰tape 2: Installer Java 17
      - name: â˜• Installer Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Ã‰tape 3: Cache Maven
      - name: ğŸ“¦ Cache Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      # Ã‰tape 4: Build + Package chaque service (avec JAR)
      - name: ğŸ”¨ Build Discovery Server + JAR
        run: |
          echo "ğŸš€ Build du Discovery Server..."
          cd discovery-server
          mvn clean package -DskipTests
          echo "âœ… Discovery Server compilÃ© + JAR crÃ©Ã©!"

      - name: ğŸ”¨ Build Config Server + JAR
        run: |
          echo "ğŸš€ Build du Config Server..."
          cd config-server
          mvn clean package -DskipTests
          echo "âœ… Config Server compilÃ© + JAR crÃ©Ã©!"

      - name: ğŸ”¨ Build Gateway API + JAR
        run: |
          echo "ğŸš€ Build du Gateway..."
          cd gateway-api
          mvn clean package -DskipTests
          echo "âœ… Gateway compilÃ© + JAR crÃ©Ã©!"

      - name: ğŸ”¨ Build Service Film + JAR
        run: |
          echo "ğŸš€ Build du Service Film..."
          cd service-film
          mvn clean package -DskipTests
          echo "âœ… Service Film compilÃ© + JAR crÃ©Ã©!"

      - name: ğŸ”¨ Build Cinema Service + JAR
        run: |
          echo "ğŸš€ Build du Cinema Service..."
          cd cinema
          mvn clean package -DskipTests
          echo "âœ… Cinema Service compilÃ© + JAR crÃ©Ã©!"

      - name: ğŸ”¨ Build User Management + JAR
        run: |
          echo "ğŸš€ Build du User Management..."
          cd user-management
          mvn clean package -DskipTests
          echo "âœ… User Management compilÃ© + JAR crÃ©Ã©!"

      - name: ğŸ”¨ Build Booking Service + JAR
        run: |
          echo "ğŸš€ Build du Booking Service..."
          cd service-reservation
          mvn clean package -DskipTests
          echo "âœ… Booking Service compilÃ© + JAR crÃ©Ã©!"

      - name: ğŸ‰ Build terminÃ©
        run: |
          echo "ğŸ‰ Tous les services ont Ã©tÃ© compilÃ©s avec succÃ¨s!"
          echo "ğŸ“¦ Tous les fichiers JAR sont prÃªts pour Docker!"

  # =================== JOB 2: DOCKER (seulement si build OK) ===================
  build-docker:
    needs: build-test  # â† Attend que build-test soit fini
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # â† Seulement sur la branche main

    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v3

      - name: â˜• Installer Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Rebuild les JARs (nÃ©cessaire pour Docker)
      - name: ğŸ“¦ Reconstruire tous les JARs
        run: |
          echo "ğŸ”„ Reconstruction des JARs pour Docker..."
          for service in discovery-server config-server gateway-api service-film cinema user-management service-reservation; do
            echo "ğŸ“¦ Build JAR pour $service"
            cd $service
            mvn clean package -DskipTests
            cd ..
          done

      # Connexion Ã  Docker Hub
      - name: ğŸ³ Connexion Ã  Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build et Push chaque image Docker
      - name: ğŸ³ Build + Push Discovery Server
        run: |
          echo "ğŸ”¨ Build image Discovery Server..."
          cd discovery-server
          docker build -t jaouaderr/cinema-discovery-server:latest .
          docker push jaouaderr/cinema-discovery-server:latest
          echo "âœ… Image discovery-server pushÃ©e!"

      - name: ğŸ³ Build + Push Config Server
        run: |
          echo "ğŸ”¨ Build image Config Server..."
          cd config-server
          docker build -t jaouaderr/cinema-config-server:latest .
          docker push jaouaderr/cinema-config-server:latest
          echo "âœ… Image config-server pushÃ©e!"

      - name: ğŸ³ Build + Push Gateway API
        run: |
          echo "ğŸ”¨ Build image Gateway..."
          cd gateway-api
          docker build -t jaouaderr/cinema-gateway-api:latest .
          docker push jaouaderr/cinema-gateway-api:latest
          echo "âœ… Image gateway-api pushÃ©e!"

      - name: ğŸ³ Build + Push Service Film
        run: |
          echo "ğŸ”¨ Build image Service Film..."
          cd service-film
          docker build -t jaouaderr/cinema-service-film:latest .
          docker push jaouaderr/cinema-service-film:latest
          echo "âœ… Image service-film pushÃ©e!"

      - name: ğŸ³ Build + Push Cinema Service
        run: |
          echo "ğŸ”¨ Build image Cinema..."
          cd cinema
          docker build -t jaouaderr/cinema-cinema:latest .
          docker push jaouaderr/cinema-cinema:latest
          echo "âœ… Image cinema pushÃ©e!"

      - name: ğŸ³ Build + Push User Management
        run: |
          echo "ğŸ”¨ Build image User Management..."
          cd user-management
          docker build -t jaouaderr/cinema-user-management:latest .
          docker push jaouaderr/cinema-user-management:latest
          echo "âœ… Image user-management pushÃ©e!"

      - name: ğŸ³ Build + Push Booking Service
        run: |
          echo "ğŸ”¨ Build image Booking Service..."
          cd service-reservation
          docker build -t jaouaderr/cinema-service-reservation:latest .
          docker push jaouaderr/cinema-service-reservation:latest
          echo "âœ… Image service-reservation pushÃ©e!"

      - name: ğŸ‰ Docker terminÃ©
        run: |
          echo "ğŸ‰ Toutes les images Docker ont Ã©tÃ© crÃ©Ã©es et envoyÃ©es sur Docker Hub!"
          echo "ğŸš€ Tes microservices sont maintenant disponibles publiquement!"
          echo "ğŸ“‹ Images crÃ©Ã©es:"
          echo "   - jaouaderr/cinema-discovery-server:latest"
          echo "   - jaouaderr/cinema-config-server:latest"
          echo "   - jaouaderr/cinema-gateway-api:latest"
          echo "   - jaouaderr/cinema-service-film:latest"
          echo "   - jaouaderr/cinema-cinema:latest"
          echo "   - jaouaderr/cinema-user-management:latest"
          echo "   - jaouaderr/cinema-service-reservation:latest"