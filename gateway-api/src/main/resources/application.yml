server:
  port: 8080

spring:
  application:
    name: api-gateway
  config:
    import: "optional:configserver:http://localhost:8888/"

# âš¡ CONFIGURATION RESILIENCE4J - Ã€ AJOUTER DANS application.yml ou application-docker.yml

# ============================================
# ðŸ”´ CIRCUIT BREAKER CONFIGURATION
# ============================================
resilience4j:
  circuitbreaker:
    # Configuration des circuit breakers individuels
    instances:
      # ðŸŽ¬ Circuit Breaker pour MOVIE SERVICE
      movieServiceCircuitBreaker:
        # Taux d'Ã©chec pour ouvrir le circuit (50% = si 50% des requÃªtes Ã©chouent)
        failureRateThreshold: 50

        # Taux de requÃªtes lentes pour ouvrir le circuit (80% = si 80% sont lentes)
        slowCallRateThreshold: 80

        # DurÃ©e considÃ©rÃ©e comme "lente" (2 secondes)
        slowCallDurationThreshold: 2s

        # Nombre minimum de requÃªtes avant d'Ã©valuer (10 requÃªtes)
        # Le circuit ne s'ouvrira pas tant qu'on n'a pas au moins 10 requÃªtes
        minimumNumberOfCalls: 10

        # Nombre de requÃªtes pour calculer le taux (fenÃªtre glissante de 20)
        slidingWindowSize: 20

        # Type de fenÃªtre : COUNT_BASED (par nombre) ou TIME_BASED (par temps)
        slidingWindowType: COUNT_BASED

        # DurÃ©e d'attente avant de passer en HALF_OPEN (30 secondes)
        waitDurationInOpenState: 30s

        # Nombre de requÃªtes en HALF_OPEN pour tester (3 tentatives)
        permittedNumberOfCallsInHalfOpenState: 3

        # Passer automatiquement en HALF_OPEN (true) ou attendre (false)
        automaticTransitionFromOpenToHalfOpenEnabled: true

        # Enregistrer les exceptions comme des Ã©checs
#        recordExceptions:
#          - org.springframework.web.client.HttpServerErrorException
#          - java.util.concurrent.TimeoutException
#          - java.io.IOException

        # Ignorer certaines exceptions (ne pas compter comme Ã©chec)
#        ignoreExceptions:
#          - com.spring.gateway.exception.BusinessException

      # ðŸŽ­ Circuit Breaker pour CINEMA SERVICE
      cinemaServiceCircuitBreaker:
        failureRateThreshold: 50
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 2s
        minimumNumberOfCalls: 10
        slidingWindowSize: 20
        slidingWindowType: COUNT_BASED
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true

      # ðŸŽ« Circuit Breaker pour BOOKING SERVICE
      bookingServiceCircuitBreaker:
        failureRateThreshold: 50
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 3s  # Booking peut Ãªtre plus lent (transactions)
        minimumNumberOfCalls: 10
        slidingWindowSize: 20
        slidingWindowType: COUNT_BASED
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true

      # ðŸ‘¤ Circuit Breaker pour USER MANAGEMENT
      userManagementCircuitBreaker:
        failureRateThreshold: 50
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 1s  # Auth doit Ãªtre rapide
        minimumNumberOfCalls: 10
        slidingWindowSize: 20
        slidingWindowType: COUNT_BASED
        waitDurationInOpenState: 20s  # Moins d'attente pour l'auth
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true

  # ============================================
  # ðŸ”„ RETRY CONFIGURATION
  # ============================================
  retry:
    instances:
      # ðŸŽ¬ Retry pour MOVIE SERVICE
      movieServiceRetry:
        # Nombre maximum de tentatives (3 au total = 1 initiale + 2 retry)
        maxAttempts: 3

        # Attente entre les tentatives (500ms)
        waitDuration: 500ms

        # Multiplier le dÃ©lai Ã  chaque tentative (backoff exponentiel)
        enableExponentialBackoff: true

        # Multiplicateur pour le backoff (2x Ã  chaque fois)
        exponentialBackoffMultiplier: 2

        # Retry sur ces exceptions
        retryExceptions:
          - org.springframework.web.client.ResourceAccessException
          - java.util.concurrent.TimeoutException

        # Ne PAS retry sur ces exceptions
#        ignoreExceptions:
#          - java.lang.IllegalArgumentException

      # ðŸŽ­ Retry pour CINEMA SERVICE
      cinemaServiceRetry:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2

      # ðŸŽ« Retry pour BOOKING SERVICE (moins de retry pour Ã©viter doublons)
      bookingServiceRetry:
        maxAttempts: 2  # Seulement 2 tentatives (risque de double rÃ©servation)
        waitDuration: 1s
        enableExponentialBackoff: false

      # ðŸ‘¤ Retry pour USER MANAGEMENT
      userManagementRetry:
        maxAttempts: 3
        waitDuration: 300ms  # Plus rapide pour l'auth
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2

  # ============================================
  # â±ï¸ TIME LIMITER CONFIGURATION (Timeouts)
  # ============================================
  timelimiter:
    instances:
      # ðŸŽ¬ Timeout pour MOVIE SERVICE
      movieServiceTimeLimiter:
        timeoutDuration: 3s  # Maximum 3 secondes
        cancelRunningFuture: true  # Annuler si timeout

      # ðŸŽ­ Timeout pour CINEMA SERVICE
      cinemaServiceTimeLimiter:
        timeoutDuration: 3s
        cancelRunningFuture: true

      # ðŸŽ« Timeout pour BOOKING SERVICE
      bookingServiceTimeLimiter:
        timeoutDuration: 5s  # Plus de temps pour les transactions
        cancelRunningFuture: true

      # ðŸ‘¤ Timeout pour USER MANAGEMENT
      userManagementTimeLimiter:
        timeoutDuration: 2s  # Auth doit Ãªtre rapide
        cancelRunningFuture: true

  # ============================================
  # ðŸš¢ BULKHEAD CONFIGURATION (Isolation)
  # ============================================
  bulkhead:
    instances:
      # ðŸŽ¬ Bulkhead pour MOVIE SERVICE
      movieServiceBulkhead:
        # Nombre max d'appels concurrents
        maxConcurrentCalls: 10

        # DurÃ©e max d'attente pour un slot (0 = pas d'attente)
        maxWaitDuration: 0ms

      # ðŸŽ­ Bulkhead pour CINEMA SERVICE
      cinemaServiceBulkhead:
        maxConcurrentCalls: 10
        maxWaitDuration: 0ms

      # ðŸŽ« Bulkhead pour BOOKING SERVICE
      bookingServiceBulkhead:
        maxConcurrentCalls: 5  # Moins de concurrence pour Ã©viter les conflits
        maxWaitDuration: 100ms

      # ðŸ‘¤ Bulkhead pour USER MANAGEMENT
      userManagementBulkhead:
        maxConcurrentCalls: 20  # Plus pour l'auth (beaucoup d'utilisateurs)
        maxWaitDuration: 0ms

  # ============================================
  # ðŸ›¡ï¸ RATE LIMITER CONFIGURATION
  # ============================================
  ratelimiter:
    instances:
      # ðŸŽ¬ Rate Limiter pour MOVIE SERVICE
      movieServiceRateLimiter:
        # PÃ©riode de rafraÃ®chissement (1 seconde)
        limitRefreshPeriod: 1s

        # Nombre de permissions par pÃ©riode (100 requÃªtes/seconde)
        limitForPeriod: 100

        # DurÃ©e d'attente pour obtenir une permission (0 = Ã©chec immÃ©diat)
        timeoutDuration: 0ms

      # ðŸŽ­ Rate Limiter pour CINEMA SERVICE
      cinemaServiceRateLimiter:
        limitRefreshPeriod: 1s
        limitForPeriod: 100
        timeoutDuration: 0ms

      # ðŸŽ« Rate Limiter pour BOOKING SERVICE
      bookingServiceRateLimiter:
        limitRefreshPeriod: 1s
        limitForPeriod: 50  # Moins pour Ã©viter la surcharge
        timeoutDuration: 100ms

      # ðŸ‘¤ Rate Limiter pour USER MANAGEMENT
      userManagementRateLimiter:
        limitRefreshPeriod: 1s
        limitForPeriod: 200  # Plus pour l'auth
        timeoutDuration: 0ms

# ============================================
# ðŸ“Š ACTUATOR & METRICS
# ============================================
management:
  endpoints:
    web:
      exposure:
        include: "*"  # Expose tous les endpoints Actuator
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true  # Afficher l'Ã©tat des circuit breakers dans /actuator/health

# ============================================
# ðŸ“ LOGGING
# ============================================
logging:
  level:
    io.github.resilience4j: DEBUG  # Voir les logs Resilience4j en dÃ©tail

# ============================================
# ðŸ’¡ EXPLICATION DES VALEURS
# ============================================

# CIRCUIT BREAKER :
# -----------------
# failureRateThreshold: 50
#   â†’ Si 50% des requÃªtes Ã©chouent, ouvre le circuit
#
# slowCallRateThreshold: 80
#   â†’ Si 80% des requÃªtes sont lentes, ouvre le circuit
#
# slowCallDurationThreshold: 2s
#   â†’ Une requÃªte est "lente" si elle prend plus de 2s
#
# minimumNumberOfCalls: 10
#   â†’ Il faut au moins 10 requÃªtes avant d'ouvrir le circuit
#   â†’ Ã‰vite d'ouvrir trop vite (1 erreur sur 2 requÃªtes = pas grave)
#
# waitDurationInOpenState: 30s
#   â†’ Attendre 30s avant de tester si le service est revenu
#
# permittedNumberOfCallsInHalfOpenState: 3
#   â†’ Faire 3 requÃªtes de test en HALF_OPEN
#   â†’ Si les 3 rÃ©ussissent â†’ CLOSED
#   â†’ Si 1 Ã©choue â†’ OPEN

# RETRY :
# -------
# maxAttempts: 3
#   â†’ RÃ©essayer 3 fois (1 initiale + 2 retry)
#
# waitDuration: 500ms
#   â†’ Attendre 500ms entre les tentatives
#
# enableExponentialBackoff: true
#   â†’ Augmenter le dÃ©lai Ã  chaque tentative
#   â†’ Tentative 1 â†’ attendre 500ms
#   â†’ Tentative 2 â†’ attendre 1000ms (500ms Ã— 2)
#   â†’ Tentative 3 â†’ attendre 2000ms (1000ms Ã— 2)

# TIME LIMITER :
# --------------
# timeoutDuration: 3s
#   â†’ Si la requÃªte prend plus de 3s â†’ timeout
#
# cancelRunningFuture: true
#   â†’ Annuler la requÃªte si timeout (libÃ©rer les ressources)

# BULKHEAD :
# ----------
# maxConcurrentCalls: 10
#   â†’ Maximum 10 requÃªtes simultanÃ©es vers ce service
#   â†’ La 11Ã¨me sera rejetÃ©e (ou mise en attente si maxWaitDuration > 0)

# RATE LIMITER :
# --------------
# limitForPeriod: 100
#   â†’ 100 requÃªtes max par pÃ©riode
#
# limitRefreshPeriod: 1s
#   â†’ PÃ©riode de 1 seconde
#   â†’ = 100 requÃªtes/seconde max

























#server:
#  port: 8080  # Le port de l'API Gateway
#
#spring:
#  application:
#    name: api-gateway  # Nom de l'application
#
#  main:
#    web-application-type: reactive  # Spï¿½cifie que l'application est rï¿½active
#
#
##  Config before
##  cloud:
##    gateway:
##      routes:
##        - id: user-management  # Identifiant unique pour cette route
##          uri: http://localhost:8083  # URI du microservice user-management
##          predicates:
##            - Path=/api/auth/**  # Toute requï¿½te vers /api/auth/** sera redirigï¿½e vers ce microservice
##          filters:
##            - AddRequestHeader=X-Request-Foo, Bar  # Exemple de filtre, ajoute un en-tï¿½te ï¿½ la requï¿½te (optionnel)
##
##        - id: movie-service
##          uri: http://localhost:8085
##          predicates:
##            - Path=/movies/v1/**
##
##        - id: booking-service
##          uri: http://localhost:7000
##          predicates:
##            - Path=/reservations/v1/**
##
##        - id: cinema-service
##          uri: http://localhost:9090
##          predicates:
##            - Path=/cinema/v1/**
##  Config before
#  cloud:
#    gateway:
#      discovery:
#        locator:
#          enabled: true
#          lower-case-service-id: true
#      routes:
#        - id: user-management
#          uri: lb://user-management
#          predicates:
#            - Path=/api/auth/**
#          filters:
#            - AddRequestHeader=X-Request-Foo, Bar
#
#        - id: movie-service
#          uri: lb://movie-service
#          predicates:
#            - Path=/movies/v1/**
#
#        - id: booking-service
#          uri: lb://booking-service
#          predicates:
#            - Path=/reservations/v1/**
#
#        - id: cinema-service
#          uri: lb://cinema-service
#          predicates:
#            - Path=/cinema/v1/**
#app:
#  jwt:
#    secret: LnX1yH3pYq6gTbWxV2zQ8uRfNjKrI0VxTk6b2o4D4q9w2U5QjX
#    expirationMs: 3600000
#
## Le URI pointe vers ton microservice user-management qui tourne sur le port 8083.
## Toute requï¿½te vers /api/auth/** sera redirigï¿½e vers ce service
#
## Configuration de l'Actuator pour exposer tous les endpoints et observer les routes disponibles
#management:
#  endpoints:
#    web:
#      exposure:
#        include: "*"  # Expose tous les endpoints d'Actuator (comme /actuator/health, /actuator/routes, etc.)
#
## Actuator : permet de surveiller l'ï¿½tat de votre API Gateway et les routes disponibles
#
#eureka:
#  client:
#    service-url:
#      defaultZone: http://localhost:8761/eureka
