server:
  port: 8080

spring:
  application:
    name: api-gateway
  config:
    import: # D√©sactive le config server pour Docker

  main:
    web-application-type: reactive

  cloud:
    gateway:
      # COMPLETEMENT DESACTIVER discovery locator pour √©viter les routes automatiques
      discovery:
        locator:
          enabled: false


      # ============================================
      # üåê ROUTES AVEC CIRCUIT BREAKER
      # ============================================
      routes:
        # ============================================
        # üë§ ROUTE USER MANAGEMENT (Authentication)
        # ============================================
        # Routes avec priorit√© explicite et noms uniques

        - id: auth-route
          uri: http://user-management:8083  # Utiliser nom Docker direct
          predicates:
            - Path=/api/auth/**
          filters:
            - AddRequestHeader=X-Request-Foo, Bar

            # ‚ö° CIRCUIT BREAKER
            - name: CircuitBreaker
              args:
                name: userManagementCircuitBreaker
                fallbackUri: forward:/fallback/user-management
            # üîÑ RETRY
            - name: Retry
              args:
                retries: 3
                backoff:
                  firstBackoff: 300ms
                  maxBackoff: 2s
                  factor: 2
                  basedOnPreviousValue: false

          metadata:
            response-timeout: 5000
            connect-timeout: 3000

        # ============================================
        # üé¨ ROUTE MOVIE SERVICE
        # ============================================
        - id: movies-route
          uri: http://movie-service:8080
          predicates:
            - Path=/movies/v1/**
          filters:
            # ‚ö° CIRCUIT BREAKER
            - name: CircuitBreaker
              args:
                name: movieServiceCircuitBreaker
                fallbackUri: forward:/fallback/movie-service

            # üîÑ RETRY
            - name: Retry
              args:
                retries: 3
                backoff:
                  firstBackoff: 500ms
                  maxBackoff: 3s
                  factor: 2
                  basedOnPreviousValue: false

          metadata:
            response-timeout: 3000
            connect-timeout: 1000


        # ============================================
        # üé´ ROUTE BOOKING SERVICE (Reservations)
        # ============================================
        - id: reservations-route
          uri: http://booking-service:7000
          predicates:
            - Path=/reservations/v1/**
          filters:
            # ‚ö° CIRCUIT BREAKER
            - name: CircuitBreaker
              args:
                name: bookingServiceCircuitBreaker
                fallbackUri: forward:/fallback/booking-service

            # üîÑ RETRY (moins de retry pour √©viter double r√©servation)
            - name: Retry
              args:
                retries: 2
                backoff:
                  firstBackoff: 1s
                  maxBackoff: 3s
                  factor: 2
                  basedOnPreviousValue: false

          metadata:
            response-timeout: 5000  # Plus de temps pour les transactions
            connect-timeout: 1000

        # ============================================
        # üé≠ ROUTE CINEMA SERVICE
        # ============================================
        - id: cinema-route
          uri: http://cinema-service:9090
          predicates:
            - Path=/cinema/v1/**
          filters:
            # ‚ö° CIRCUIT BREAKER
            - name: CircuitBreaker
              args:
                name: cinemaServiceCircuitBreaker
                fallbackUri: forward:/fallback/cinema-service

            # üîÑ RETRY
            - name: Retry
              args:
                retries: 3
                backoff:
                  firstBackoff: 500ms
                  maxBackoff: 3s
                  factor: 2
                  basedOnPreviousValue: false

          metadata:
            response-timeout: 3000
            connect-timeout: 1000

# ============================================
# üî¥ CONFIGURATION RESILIENCE4J
# ============================================
resilience4j:
  circuitbreaker:
    instances:
      userManagementCircuitBreaker:
        failureRateThreshold: 50
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 1s
        minimumNumberOfCalls: 5  # Moins en Docker (moins de trafic)
        slidingWindowSize: 10
        slidingWindowType: COUNT_BASED
        waitDurationInOpenState: 20s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true

      movieServiceCircuitBreaker:
        failureRateThreshold: 50
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 2s
        minimumNumberOfCalls: 5
        slidingWindowSize: 10
        slidingWindowType: COUNT_BASED
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true

      cinemaServiceCircuitBreaker:
        failureRateThreshold: 50
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 2s
        minimumNumberOfCalls: 5
        slidingWindowSize: 10
        slidingWindowType: COUNT_BASED
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true

      bookingServiceCircuitBreaker:
        failureRateThreshold: 50
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 3s
        minimumNumberOfCalls: 5
        slidingWindowSize: 10
        slidingWindowType: COUNT_BASED
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true

  timelimiter:
    instances:
      userManagementCircuitBreaker:
        timeoutDuration: 2s
        cancelRunningFuture: true
      movieServiceCircuitBreaker:
        timeoutDuration: 3s
        cancelRunningFuture: true
      cinemaServiceCircuitBreaker:
        timeoutDuration: 3s
        cancelRunningFuture: true
      bookingServiceCircuitBreaker:
        timeoutDuration: 5s
        cancelRunningFuture: true



# Configuration Eureka - SIMPLIFIEE pour Docker
eureka:
  client:
    enabled: false
    service-url:
      defaultZone: http://discovery-server:8761/eureka
    register-with-eureka: true
    fetch-registry: false  # D√âSACTIV√â: on utilise les routes manuelles directes
  instance:
    prefer-ip-address: false
    hostname: api-gateway
    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30

# Configuration JWT
app:
  jwt:
    secret: LnX1yH3pYq6gTbWxV2zQ8uRfNjKrI0VxTk6b2o4D4q9w2U5QjX
    expirationMs: 3600000

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true
    ratelimiters:
      enabled: true

# Logging avec plus de d√©tails pour debug
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping: DEBUG
    org.springframework.cloud.gateway.route: DEBUG
    reactor.netty.http.client: DEBUG
    com.netflix.loadbalancer: DEBUG
    root: INFO

# D√©sactiver cloud config
cloud:
  config:
    enabled: false