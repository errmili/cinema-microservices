<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <!-- ðŸ“ CONFIGURATION PROFESSIONNELLE DE LOGGING - VERSION SIMPLIFIÃ‰E

    Cette version N'UTILISE PAS les patterns Spring Boot avancÃ©s (%clr, %wEx)
    qui causaient l'erreur. Elle fonctionne avec Logback standard.
    -->

    <!-- ============================================= -->
    <!-- ðŸ“Œ PROPRIÃ‰TÃ‰S (variables rÃ©utilisables)      -->
    <!-- ============================================= -->

    <!-- Dossier oÃ¹ stocker les logs -->
    <property name="LOG_PATH" value="./logs" />

    <!-- Nom du fichier de log -->
    <property name="LOG_FILE" value="gateway" />

    <!-- Pattern pour les logs en console (simplifiÃ©, sans couleurs) -->
    <property name="CONSOLE_LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{correlationId:-NO-ID}] %-5level %-40.40logger{39} : %msg%n" />

    <!-- Pattern pour les logs en fichier (identique) -->
    <property name="FILE_LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{correlationId:-NO-ID}] %-5level %-40.40logger{39} : %msg%n" />


    <!-- ============================================= -->
    <!-- ðŸ–¥ï¸ APPENDER CONSOLE (pour dÃ©veloppement)    -->
    <!-- ============================================= -->

    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>

        <!-- Filtre : log seulement Ã  partir de DEBUG -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>DEBUG</level>
        </filter>
    </appender>


    <!-- ============================================= -->
    <!-- ðŸ“„ APPENDER FICHIER (pour production)       -->
    <!-- ============================================= -->

    <!-- Fichier principal : logs de toute l'application -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE}.log</file>

        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>

        <!-- ðŸ”„ ROTATION : crÃ©er un nouveau fichier chaque jour -->
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- Pattern du nom : gateway-2025-10-27.log -->
            <fileNamePattern>${LOG_PATH}/${LOG_FILE}-%d{yyyy-MM-dd}.log</fileNamePattern>

            <!-- Garder 30 jours d'historique -->
            <maxHistory>30</maxHistory>

            <!-- Taille max totale : 1 GB -->
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>

        <!-- Filtre : log Ã  partir de INFO (pas DEBUG) -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>INFO</level>
        </filter>
    </appender>


    <!-- ============================================= -->
    <!-- âŒ APPENDER ERREURS (fichier sÃ©parÃ©)        -->
    <!-- ============================================= -->

    <!-- Fichier sÃ©parÃ© pour les erreurs uniquement -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE}-errors.log</file>

        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${LOG_FILE}-errors-%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
            <totalSizeCap>500MB</totalSizeCap>
        </rollingPolicy>

        <!-- Filtre : seulement ERROR et FATAL -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>ERROR</level>
        </filter>
    </appender>


    <!-- ============================================= -->
    <!-- ðŸ“Š APPENDER JSON (pour ELK/Splunk)          -->
    <!-- ============================================= -->

    <!-- Logs en format JSON structurÃ© pour outils de monitoring -->
    <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE}-json.log</file>

        <!-- Encoder JSON avec Logstash -->
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <!-- Ajouter des champs custom -->
            <customFields>{"app":"cinema-gateway","environment":"production"}</customFields>

            <!-- Inclure le MDC (donc le correlationId) -->
            <includeMdcKeyName>correlationId</includeMdcKeyName>
        </encoder>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${LOG_FILE}-json-%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>
    </appender>


    <!-- ============================================= -->
    <!-- ðŸŽ¯ LOGGERS PAR PACKAGE                      -->
    <!-- ============================================= -->

    <!-- Logger pour ton package principal (niveau DEBUG en dev) -->
    <logger name="com.spring.gateway" level="DEBUG" />

    <!-- Logger pour les filtres (trÃ¨s dÃ©taillÃ©) -->
    <logger name="com.spring.gateway.filter" level="DEBUG" />

    <!-- Logger Spring Cloud Gateway (modÃ©rÃ©) -->
    <logger name="org.springframework.cloud.gateway" level="INFO" />

    <!-- Logger Reactor Netty (modÃ©rÃ© - sinon trop de logs !) -->
    <logger name="reactor.netty" level="INFO" />

    <!-- Logger Spring Framework (modÃ©rÃ©) -->
    <logger name="org.springframework" level="INFO" />

    <!-- Logger Hibernate/JPA (dÃ©sactivÃ© sauf si besoin) -->
    <logger name="org.hibernate" level="WARN" />


    <!-- ============================================= -->
    <!-- ðŸ“ LOGGER ROOT (par dÃ©faut)                 -->
    <!-- ============================================= -->

    <!-- Configuration selon l'environnement -->

    <!-- ðŸŸ¢ PROFIL "dev" : Logs dÃ©taillÃ©s en console -->
    <springProfile name="dev,default">
        <root level="INFO">
            <appender-ref ref="CONSOLE" />
        </root>
    </springProfile>

    <!-- ðŸ”µ PROFIL "docker" : Logs modÃ©rÃ©s (console + fichiers) -->
    <springProfile name="docker">
        <root level="INFO">
            <appender-ref ref="CONSOLE" />
            <appender-ref ref="FILE" />
            <appender-ref ref="ERROR_FILE" />
        </root>
    </springProfile>

    <!-- ðŸ”´ PROFIL "production" : Logs en fichiers + JSON -->
    <springProfile name="production,prod">
        <root level="INFO">
            <appender-ref ref="FILE" />
            <appender-ref ref="ERROR_FILE" />
            <appender-ref ref="JSON_FILE" />
        </root>
    </springProfile>

</configuration>

        <!--
        ðŸ’¡ DIFFÃ‰RENCE AVEC L'ANCIENNE VERSION
        ======================================

        AVANT (causait l'erreur) :
        - Utilisait %clr pour les couleurs (converter Spring Boot)
        - Utilisait %wEx pour les exceptions (converter Spring Boot)
        - NÃ©cessitait des classes Spring Boot spÃ©cifiques

        APRÃˆS (fonctionne partout) :
        - Patterns Logback standard uniquement
        - Pas de couleurs (mais Ã§a fonctionne !)
        - Compatible avec tous les environnements

        NOTE : Les logs sont maintenant en noir et blanc en console,
        mais c'est un petit compromis pour la stabilitÃ© !
        Si tu veux les couleurs, on les ajoutera aprÃ¨s avec une config Spring Boot complÃ¨te.

        ðŸ“Š EXEMPLE DE LOGS
        ==================

        Console :
        2025-10-27 14:30:12.001 [abc-123] INFO  CorrelationIdFilter : ðŸ†• Nouveau Correlation ID gÃ©nÃ©rÃ© : abc-123
        2025-10-27 14:30:12.002 [abc-123] INFO  LoggingFilter       : âž¡ï¸ RequÃªte entrante : GET /movies/v1/1 - IP: 127.0.0.1
        2025-10-27 14:30:12.156 [abc-123] INFO  LoggingFilter       : â¬…ï¸ âœ… SuccÃ¨s : GET /movies/v1/1 - Status: 200 - DurÃ©e: 154ms

        Fichier (gateway.log) :
        2025-10-27 14:30:12.001 [abc-123] INFO  CorrelationIdFilter : ðŸ†• Nouveau Correlation ID gÃ©nÃ©rÃ© : abc-123

        JSON (gateway-json.log) :
        {"timestamp":"2025-10-27T14:30:12.001Z","level":"INFO","logger":"CorrelationIdFilter","message":"Nouveau Correlation ID gÃ©nÃ©rÃ©","correlationId":"abc-123","app":"cinema-gateway"}
        -->